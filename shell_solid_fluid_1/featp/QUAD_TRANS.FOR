	
	SUBROUTINE QUAD_TRANS(VXY,QCOS)
	IMPLICIT  REAL* 8 (A-H,O-Z)
	COMMON/HIGH/H
	DIMENSION VXY(4,3),VXX(4,3),VX(4,3),QCOS(3,3),AX(3),AY(3),AZ(3),A(3),
     $          AW(4,3),AMID(2,3),DIS(2),RAT(2),tt(3,3),A1(3),az1(3),
     $          A12(3),A23(3),A34(3),A41(3),A123(3),A234(3),A341(3),
     $          A412(3),A14(3),AZ0(3)

!      AX(1)=VXY(2,1)-VXY(1,1)  
!	AX(2)=VXY(2,2)-VXY(1,2)  
!	AX(3)=VXY(2,3)-VXY(1,3)       !局部坐标下的X轴方向余弦(12矢量)
	
      A(1)=VXY(3,1)-VXY(1,1) 
	A(2)=VXY(3,2)-VXY(1,2)  
	A(3)=VXY(3,3)-VXY(1,3)        !局部坐标下的边13方向余弦

	A1(1)=VXY(4,1)-VXY(2,1) 
	A1(2)=VXY(4,2)-VXY(2,2)  
	A1(3)=VXY(4,3)-VXY(2,3)        !局部坐标下的边24方向余弦

!	A(1)=VXY(2,1)-VXY(1,1) 
!	A(2)=VXY(2,2)-VXY(1,2)  
!	A(3)=VXY(2,3)-VXY(1,3)        !局部坐标下的边12方向余弦

!	A1(1)=VXY(3,1)-VXY(2,1) 
!	A1(2)=VXY(3,2)-VXY(2,2)  
!	A1(3)=VXY(3,3)-VXY(2,3)        !局部坐标下的边23方向余弦


	AZ(1)=A(2)*A1(3)-A(3)*A1(2)
      AZ(2)=A(3)*A1(1)-A(1)*A1(3)
      AZ(3)=A(1)*A1(2)-A(2)*A1(1)   !局部坐标下的Z轴方向余弦(与面垂直)

	A12(1)=VXY(2,1)-VXY(1,1) 
	A12(2)=VXY(2,2)-VXY(1,2)  
	A12(3)=VXY(2,3)-VXY(1,3)        !全局局部坐标下的边12方向余弦

	A14(1)=VXY(4,1)-VXY(1,1)
	A14(2)=VXY(4,2)-VXY(1,2)
	A14(3)=VXY(4,3)-VXY(1,3)        !全局局部坐标下的边14方向余弦
	
      
	AL=AZ(1)*AZ(1)+AZ(2)*AZ(2)+AZ(3)*AZ(3)
      AL12=A12(1)*A12(1)+A12(2)*A12(2)+A12(3)*A12(3)
      AL14=A14(1)*A14(1)+A14(2)*A14(2)+A14(3)*A14(3)

	AZ0(1)=AZ(1)/SQRT(AL)
	AZ0(2)=AZ(2)/SQRT(AL)
	AZ0(3)=AZ(3)/SQRT(AL)   !平面法线的单位向量
   

	ANG=(A12(1)*AZ(1)+A12(2)*AZ(2)+A12(3)*AZ(3))/(SQRT(AL)*SQRT(AL12))
	ANG1=(A14(1)*AZ(1)+A14(2)*AZ(2)+A14(3)*AZ(3))/(SQRT(AL)*SQRT(AL14))
      IF(ANG.LT.0.AND.ANG.LT.0)THEN
	H=ABS(0.5*(AZ0(1)*A12(1)+AZ0(2)*A12(2)+AZ0(3)*A12(3)))
	ELSE
      H=0.5*(AZ0(1)*A12(1)+AZ0(2)*A12(2)+AZ0(3)*A12(3))
	ENDIF
!	az1(:)=az(:)
      X0=0.5*(VXY(1,1)+VXY(2,1))
	Y0=0.5*(VXY(1,2)+VXY(2,2))  !中面所过的点
      Z0=0.5*(VXY(1,3)+VXY(2,3))
      
!	X0=VXY(1,1)
!	Y0=VXY(1,2)     !中面所过的点
 !     Z0=VXY(1,3)
      VXX(:,:)=VXY(:,:)
	DO 20 I=1,4
	VXY(I,:)=0.0
      VXY(I,1)=-AZ(1)*(AZ(1)*(VXX(I,1)-X0)+
     $                 AZ(2)*(VXX(I,2)-Y0)+
     $				 AZ(3)*(VXX(I,3)-Z0))/AL+VXX(I,1)

      VXY(I,2)=-AZ(2)*(AZ(1)*(VXX(I,1)-X0)+
     $                 AZ(2)*(VXX(I,2)-Y0)+
     $				 AZ(3)*(VXX(I,3)-Z0))/AL+VXX(I,2)

      VXY(I,3)=-AZ(3)*(AZ(1)*(VXX(I,1)-X0)+
     $                 AZ(2)*(VXX(I,2)-Y0)+
     $				 AZ(3)*(VXX(I,3)-Z0))/AL+VXX(I,3)
20    CONTINUE

C**********************************************************************
!      DO 21 I=1,3
!	A12(I)=VXY(2,I)-VXY(1,I)
!	A23(I)=VXY(3,I)-VXY(2,I)
!	A34(I)=VXY(4,I)-VXY(3,I)
!	A41(I)=VXY(1,I)-VXY(4,I)
!21    CONTINUE
      
!      A123(1)=A12(2)*A23(3)-A12(3)*A23(2)
!	A123(2)=A12(3)*A23(1)-A12(1)*A23(3)
!	A123(3)=A12(1)*A23(2)-A12(2)*A23(1)

!	A234(1)=A23(2)*A34(3)-A23(3)*A34(2)
!	A234(2)=A23(3)*A34(1)-A23(1)*A34(3)
!	A234(3)=A23(1)*A34(2)-A23(2)*A34(1)
!
!      A341(1)=A34(2)*A41(3)-A34(3)*A41(2)
!	A341(2)=A34(3)*A41(1)-A34(1)*A41(3)
!	A341(3)=A34(1)*A41(2)-A34(2)*A41(1)

!	A412(1)=A41(2)*A12(3)-A41(3)*A12(2)
!	A412(2)=A41(3)*A12(1)-A41(1)*A12(3)
!	A412(3)=A41(1)*A12(2)-A41(2)*A12(1)

!	AL123=SQRT(A123(1)*A123(1)+A123(2)*A123(2)+A123(3)*A123(3))
 !     AL234=SQRT(A234(1)*A234(1)+A234(2)*A234(2)+A234(3)*A234(3))
!	AL341=SQRT(A341(1)*A341(1)+A341(2)*A341(2)+A341(3)*A341(3))
!	AL412=SQRT(A412(1)*A412(1)+A412(2)*A412(2)+A412(3)*A412(3))

!	A123(:)=A123(:)/AL123
!      A234(:)=A234(:)/AL234
!	A341(:)=A341(:)/AL341
!	A412(:)=A412(:)/AL412
C*************************************************************************      
!	A(1)=VXY(3,1)-VXY(1,1) 
!	A(2)=VXY(3,2)-VXY(1,2)  
!	A(3)=VXY(3,3)-VXY(1,3)        !局部坐标下的边13方向余弦

!	A1(1)=VXY(4,1)-VXY(2,1) 
!	A1(2)=VXY(4,2)-VXY(2,2)  
!	A1(3)=VXY(4,3)-VXY(2,3)        !局部坐标下的边24方向余弦

      AX(1)=VXY(2,1)-VXY(1,1) 
	AX(2)=VXY(2,2)-VXY(1,2)  
	AX(3)=VXY(2,3)-VXY(1,3)        !局部坐标下的边12方向余弦

	A1(1)=VXY(3,1)-VXY(2,1) 
	A1(2)=VXY(3,2)-VXY(2,2)  
	A1(3)=VXY(3,3)-VXY(2,3)        !局部坐标下的边23方向余弦

	AZ(1)=AX(2)*A1(3)-AX(3)*A1(2)
      AZ(2)=AX(3)*A1(1)-AX(1)*A1(3)
      AZ(3)=AX(1)*A1(2)-AX(2)*A1(1)   !局部坐标下的Z轴方向余弦(与面垂直)
	
!	AX(1)=VXY(2,1)-VXY(1,1)  
!	AX(2)=VXY(2,2)-VXY(1,2)  
!	AX(3)=VXY(2,3)-VXY(1,3)       !局部坐标下的X轴方向余弦(12矢量)

	AY(1)=AX(3)*AZ(2)-AX(2)*AZ(3)
      AY(2)=AX(1)*AZ(3)-AX(3)*AZ(1)
	AY(3)=AX(2)*AZ(1)-AX(1)*AZ(2)  !局部坐标下的Y轴方向余弦

!	AW(1,1)=0.5*(VXY(1,1)+VXY(2,1))
!	AW(1,2)=0.5*(VXY(1,2)+VXY(2,2))
!	AW(1,3)=0.5*(VXY(1,3)+VXY(2,3))    !12边中节点

!	AW(2,1)=0.5*(VXY(3,1)+VXY(4,1))
!	AW(2,2)=0.5*(VXY(3,2)+VXY(4,2))
!	AW(2,3)=0.5*(VXY(3,3)+VXY(4,3))    !34边中节点

!	AW(3,1)=0.5*(VXY(1,1)+VXY(4,1))
!	AW(3,2)=0.5*(VXY(1,2)+VXY(4,2))
!	AW(3,3)=0.5*(VXY(1,3)+VXY(4,3))    !14边中节点

!	AW(4,1)=0.5*(VXY(3,1)+VXY(2,1))
!	AW(4,2)=0.5*(VXY(3,2)+VXY(2,2))
!	AW(4,3)=0.5*(VXY(3,3)+VXY(2,3))    !32边中节点

!      AL=SQRT((AW(1,1)-AW(2,1))*(AW(1,1)-AW(2,1))+
!     $        (AW(2,2)-AW(1,2))*(AW(2,2)-AW(1,2))+
!     $        (AW(2,3)-AW(1,3))*(AW(2,3)-AW(1,3)))
	                                   !12,34边中线长
!	AMID(1,1)=(AW(2,1)-AW(1,1))/AL
!      AMID(1,2)=(AW(2,2)-AW(1,2))/AL
!	AMID(1,3)=(AW(2,3)-AW(1,3))/AL   !12,34边中节点单位向量

!      AL1=SQRT((AW(3,1)-AW(4,1))*(AW(3,1)-AW(4,1))+
!     $         (AW(3,2)-AW(4,2))*(AW(3,2)-AW(4,2))+
!     $         (AW(3,3)-AW(4,3))*(AW(3,3)-AW(4,3)))
	                                 !14,32边中线长
!	AMID(2,1)=(AW(3,1)-AW(4,1))/AL1
!      AMID(2,2)=(AW(3,2)-AW(4,2))/AL1
!	AMID(2,3)=(AW(3,3)-AW(4,3))/AL1   !14,23边中节点单位向量

!	AL2=SQRT((AMID(1,2)*AMID(2,2)-AMID(2,2)*AMID(1,3))*
 !    $         (AMID(1,2)*AMID(2,2)-AMID(2,2)*AMID(1,3))+
 !    $         (AMID(1,1)*AMID(2,3)-AMID(1,3)*AMID(2,1))*
 !    $         (AMID(1,1)*AMID(2,3)-AMID(1,3)*AMID(2,1))+
 !    $         (AMID(1,1)*AMID(2,2)-AMID(1,2)*AMID(2,1))*
 !    $         (AMID(1,1)*AMID(2,2)-AMID(1,2)*AMID(2,1))) 
                                                  !边中两条单位向量叉乘
 !     DIS(1)=AL*AL2          
!	DIS(2)=AL1*AL2
      
!	RAT(1)=MAX(AL,DIS(2))/MIN(AL,DIS(2))
 !     RAT(2)=MAX(AL1,DIS(1))/MIN(AL1,DIS(1))

!	IF(RAT(1).LE.RAT(2))THEN
!	QCOS(1,1)=AMID(1,2)*AZ(3)-AMID(1,3)*AZ(2)
!	QCOS(2,1)=AMID(1,3)*AZ(1)-AMID(1,1)*AZ(3)
!	QCOS(3,1)=AMID(1,1)*AZ(2)-AMID(1,2)*AZ(1)
 !    	QCOS(:,2)=AMID(1,:)
 !     QCOS(:,3)=AZ(:)      !构造变换矩阵
!	ELSE
 !     QCOS(1,1)=AMID(2,2)*AZ(3)-AMID(2,3)*AZ(2)
!	QCOS(2,1)=AMID(2,3)*AZ(1)-AMID(2,1)*AZ(3)
!	QCOS(3,1)=AMID(2,1)*AZ(2)-AMID(2,2)*AZ(1)
!	QCOS(:,2)=AMID(2,:)
!	QCOS(:,3)=AZ(:)
!	ENDIF



      XL=SQRT(AX(1)*AX(1)+AX(2)*AX(2)+AX(3)*AX(3))
	AX(1)=AX(1)/XL
	AX(2)=AX(2)/XL
	AX(3)=AX(3)/XL

	YL=SQRT(AY(1)*AY(1)+AY(2)*AY(2)+AY(3)*AY(3))
	AY(1)=AY(1)/YL
	AY(2)=AY(2)/YL
	AY(3)=AY(3)/YL
      
!	AZ(:)=AZ1(:)
      ZL=SQRT(AZ(1)*AZ(1)+AZ(2)*AZ(2)+AZ(3)*AZ(3))
	AZ(1)=AZ(1)/ZL
	AZ(2)=AZ(2)/ZL
	AZ(3)=AZ(3)/ZL

      QCOS(:,1)=AX(:)
	QCOS(:,2)=AY(:)
	QCOS(:,3)=AZ(:)
!	WRITE(*,*)AZ(1)*AZ(1)+AZ(2)*AZ(2)+AZ(3)*AZ(3)
    
!	do 1 i=1,3
!	do 1 j=1,3
!	tt(i,j)=0.0
!	do 1 k=1,3
!      tt(i,j)=tt(i,j)+qcos(k,i)*qcos(k,j)
!1     continue
!      X0=0.25*(VXY(1,1)+VXY(2,1)+VXY(3,1)+VXY(4,1))
!	Y0=0.25*(VXY(1,2)+VXY(2,2)+VXY(3,2)+VXY(4,2))
!      Z0=0.25*(VXY(1,3)+VXY(2,3)+VXY(3,3)+VXY(4,3))

      VX(:,1)=VXY(:,1)- VXY(1,1)  !X0 
	VX(:,2)=VXY(:,2)- VXY(1,2)  !Y0 
      VX(:,3)=VXY(:,3)- VXY(1,3)  !Z0

	DO 10 I=1,4
	DO 10 J=1,3
	VXY(I,J)=0.0
      DO 10 K=1,3
	VXY(I,J)=VXY(I,J)+VX(I,K)*QCOS(K,J)
10    CONTINUE

	RETURN
	END